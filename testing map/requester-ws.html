<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Requester – Live Map Tracker</title>
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #0f0f0f;
      color: #fff;
      display: flex;
      gap: 24px;
      padding: 20px;
    }
    canvas {
      border: 3px solid #222;
      image-rendering: pixelated;
      background: #151515;
      border-radius: 10px;
      box-shadow: 0 0 25px rgba(0,0,0,0.4);
    }
    #panel {
      width: 330px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    #start {
      background: #0fb9b1;
      color: #fff;
    }
    #stop {
      background: #eb3b5a;
      color: #fff;
    }
    input {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: none;
      margin-top: 2px;
    }
    .info-box {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      color: #ccc;
      box-shadow: inset 0 0 6px rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>
  <div>
    <canvas id="mapCanvas" width="800" height="600"></canvas>
  </div>

  <div id="panel">
    <h2>Requester Dashboard</h2>
    <div>Status: <span id="status">offline</span></div>
    <div>
      Runner ID: <input id="subRunner" value="runner-1" />
      Token: <input id="token" value="req-token-1" />
    </div>
    <div>
      <button id="subscribe">Subscribe</button>
      <button id="start">Start Tracking</button>
      <button id="stop">Stop Tracking</button>
    </div>
    <div class="info-box" id="infoBox">
      <div><strong>Runner:</strong> —</div>
      <div><strong>Lat:</strong> —</div>
      <div><strong>Lon:</strong> —</div>
      <div><strong>Pixel:</strong> —</div>
    </div>
  </div>

<script>
const MAP_SRC = 'mapjiit.jpg';
const WS_URL = 'ws://localhost:8080';
const REQUESTER_ID = 'requester-1';

const geoRef = {
  // approximate calibration for your test zone
  latA: 28.610500, lonA: 77.208500, // top-left
  latB: 28.608000, lonB: 77.213000, // bottom-right
  xA: 0, yA: 0, xB: 800, yB: 600
};

function latLonToPixel(lat, lon) {
  const { latA, lonA, latB, lonB, xA, yA, xB, yB } = geoRef;
  const x = ((lon - lonA) / (lonB - lonA)) * (xB - xA) + xA;
  const y = ((latA - lat) / (latA - latB)) * (yB - yA) + yA;
  return { x, y };
}

const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');
const statusEl = document.getElementById('status');
const subscribeBtn = document.getElementById('subscribe');
const subInput = document.getElementById('subRunner');
const tokenInput = document.getElementById('token');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const infoBox = document.getElementById('infoBox');

let img = new Image();
img.src = MAP_SRC;
let ws = null;
let tracking = true;
let runnerState = null;
let trail = [];

function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    statusEl.textContent = 'connected';
    ws.send(JSON.stringify({
      type: 'register',
      role: 'requester',
      id: REQUESTER_ID,
      token: tokenInput.value
    }));
  };
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'pos' && tracking) {
      const pixel = latLonToPixel(msg.lat, msg.lon);
      runnerState = { ...msg, ...pixel };
      trail.unshift({ x: pixel.x, y: pixel.y });
      if (trail.length > 120) trail.pop();
      draw();
      updateInfo(runnerState);
    }
  };
  ws.onclose = () => statusEl.textContent = 'offline';
}
connectWS();

subscribeBtn.onclick = () => {
  ws.send(JSON.stringify({
    type: 'subscribe',
    requesterId: REQUESTER_ID,
    token: tokenInput.value,
    runnerId: subInput.value
  }));
};

startBtn.onclick = () => {
  tracking = true;
  infoBox.style.border = "2px solid #0fb9b1";
};
stopBtn.onclick = () => {
  tracking = false;
  infoBox.style.border = "2px solid #eb3b5a";
};

img.onload = () => {
  canvas.width = img.width;
  canvas.height = img.height;
  draw();
};

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0);
  drawTrail();
  drawRunner();
}

function drawTrail() {
  ctx.save();
  ctx.globalAlpha = 0.5;
  ctx.strokeStyle = '#f9ca24';
  ctx.lineWidth = 3;
  ctx.beginPath();
  for (let i = 0; i < trail.length; i++) {
    const p = trail[i];
    if (i === 0) ctx.moveTo(p.x, p.y);
    else ctx.lineTo(p.x, p.y);
  }
  ctx.stroke();
  ctx.restore();
}

function drawRunner() {
  if (!runnerState) return;
  ctx.beginPath();
  ctx.shadowColor = '#00e5ff';
  ctx.shadowBlur = 12;
  ctx.fillStyle = '#00e5ff';
  ctx.arc(runnerState.x, runnerState.y, 8, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
}

function updateInfo(s) {
  infoBox.innerHTML = `
    <div><strong>Runner:</strong> ${s.runnerId}</div>
    <div><strong>Lat:</strong> ${s.lat.toFixed(6)}</div>
    <div><strong>Lon:</strong> ${s.lon.toFixed(6)}</div>
    <div><strong>Pixel:</strong> (${s.x.toFixed(1)}, ${s.y.toFixed(1)})</div>
  `;
}
</script>
</body>
</html>
