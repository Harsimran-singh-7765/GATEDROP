<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Runner (GPS Live)</title>
  <style>
    body{font-family:Inter,system-ui;padding:16px;display:flex;gap:16px;}
    canvas{border:2px solid #111; image-rendering: pixelated;}
  </style>
</head>
<body>
  <div>
    <canvas id="mapCanvas" width="800" height="600"></canvas>
  </div>
  <div>
    <h3>Runner (GPS Live)</h3>
    <div>Status: <span id="status">offline</span></div>
    <button id="start">Start GPS</button>
    <pre id="log" style="max-height:300px;overflow:auto;background:#fafafa;padding:8px;border:1px solid #eee;"></pre>
  </div>

<script>
const MAP_SRC = 'mapjiit.jpg';
const WS_URL = 'ws://localhost:8080';  // change if server deployed
const RUNNER_ID = 'runner-1';
const RUNNER_TOKEN = 'run-token-1';

const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('start');

let ws = null;
let img = new Image(); img.src = MAP_SRC;

function log(msg){ logEl.textContent = `${new Date().toLocaleTimeString()} - ${msg}\n` + logEl.textContent; }

function connectWS(){
  ws = new WebSocket(WS_URL);
  ws.addEventListener('open', () => {
    statusEl.textContent = 'connected';
    ws.send(JSON.stringify({ type:'register', role:'runner', id:RUNNER_ID, token:RUNNER_TOKEN }));
    log('connected to relay');
  });
  ws.addEventListener('message', e => log(`server: ${e.data}`));
  ws.addEventListener('close', () => { statusEl.textContent='offline'; setTimeout(connectWS,1000); });
}
connectWS();

img.onload = () => { canvas.width = img.width; canvas.height = img.height; drawMap(); };

function drawMap(){
  ctx.drawImage(img,0,0);
}

function sendPos(lat, lon){
  const msg = { type:'pos', runnerId:RUNNER_ID, lat, lon, t:Date.now() };
  if(ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(msg));
  log(`sent GPS: lat=${lat.toFixed(6)}, lon=${lon.toFixed(6)}`);
}

// GPS Tracking
let watchId = null;
function startTracking(){
  if(!navigator.geolocation){ alert("Geolocation not supported"); return; }
  if(watchId) navigator.geolocation.clearWatch(watchId);

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      sendPos(latitude, longitude);
    },
    err => log(`error: ${err.message}`),
    { enableHighAccuracy:true, maximumAge:1000, timeout:5000 }
  );
  startBtn.disabled = true;
  log('GPS tracking started');
}

startBtn.onclick = startTracking;
</script>
</body>
</html>
